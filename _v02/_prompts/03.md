# Prompt 03 — FastAPI backend bootstrap

Build the FastAPI backend foundation and extend the Ansible playbook to deploy it on the server.

## Context

`_v01` delivered: Nginx + HTTPS + static placeholder page serving on `appsec.cc`.
The server is live but has no backend whatsoever.

## Goal

After running the Ansible playbook, `curl https://appsec.cc/api/health` must return
`{"status": "ok"}`.

## Files to create

### Application code

```
_v02/
├── app/
│   ├── __init__.py
│   ├── main.py        # FastAPI app — /api/health only, config loaded at startup
│   └── config.py      # Loads app.yaml, .env, questions.txt, users.yaml
├── data/
│   └── config/
│       ├── app.yaml                      # Configuration générale
│       ├── questions.txt                 # Questions de cadrage
│       ├── users.yaml                    # Utilisateurs autorisés
│       └── prompts/
│           ├── system_response.txt
│           ├── system_attention.txt
│           └── system_structure.txt
├── requirements.txt
└── .env.example
```

### Ansible updates

Extend `_v02/ansible/playbook.yml` (which starts from the _v01 state — Nginx + HTTPS) to add:

1. Install `python3.12-venv` system package
2. Create system user `pas-assistant` (no login shell)
3. Create `/opt/pas-assistant/` directory structure with correct ownership
4. Copy app source code (`app/`) from repo to server
5. Copy config files (`data/config/`) from repo to server
6. Copy `requirements.txt` to server
7. Copy `.env` from `ansible/files/.env` (user must create this file from `.env.example`)
8. Create Python virtualenv at `/opt/pas-assistant/venv/`
9. Install Python dependencies via pip
10. Deploy `pas-assistant.service` systemd unit from template
11. Enable and start the service (with `daemon_reload: true`)
12. Update Nginx HTTPS config to add `proxy_pass /api/ → http://127.0.0.1:8000`
    with `proxy_read_timeout 300s` and `client_max_body_size 50M`

New Ansible templates:
- `ansible/templates/pas-assistant.service.j2` — systemd service unit
- `ansible/templates/nginx-https.conf.j2` — updated (adds `/api/` proxy block)

## Out of scope (this step)

- Authentication (OAuth2, Azure AD) — users.yaml exists but is not enforced yet
- Any business logic endpoint (parsing, anonymization, generation...)
- Bot Teams
- Log rotation, monitoring

## Run command

```bash
cp _v02/.env.example _v02/ansible/files/.env
# fill in _v02/ansible/files/.env with real secrets
cd _v02/ansible
ansible-playbook -i inventory playbook.yml
```
