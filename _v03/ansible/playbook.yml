---
- name: Deploy PAS Assistant
  hosts: all
  become: true

  vars_files:
    - vars/vault.yml

  vars:
    domain: appsec.cc
    web_root: /opt/pas-assistant/web
    admin_email: admin@appsec.cc
    app_dir: /opt/pas-assistant
    app_user: pas-assistant

  tasks:

    # -------------------------------------------------------------------------
    # System packages
    # -------------------------------------------------------------------------

    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install system packages
      apt:
        name:
          - nginx
          - certbot
          - python3-certbot-nginx
          - python3.12
          - python3.12-venv
          - python3-pip
        state: present

    # -------------------------------------------------------------------------
    # System user
    # -------------------------------------------------------------------------

    - name: Create pas-assistant system user
      user:
        name: "{{ app_user }}"
        system: true
        shell: /usr/sbin/nologin
        home: "{{ app_dir }}"
        create_home: false

    # -------------------------------------------------------------------------
    # Directory structure
    # -------------------------------------------------------------------------

    - name: Create application directories
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"
      loop:
        - "{{ app_dir }}"
        - "{{ app_dir }}/app"
        - "{{ app_dir }}/data"
        - "{{ app_dir }}/data/config"
        - "{{ app_dir }}/data/config/prompts"
        - "{{ app_dir }}/data/corpus"
        - "{{ app_dir }}/data/corpus/files"
        - "{{ app_dir }}/data/projects"
        - "{{ web_root }}"
        - /var/log/pas-assistant

    - name: Set log directory ownership
      file:
        path: /var/log/pas-assistant
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    # -------------------------------------------------------------------------
    # Static web interface
    # -------------------------------------------------------------------------

    - name: Deploy web interface
      copy:
        src: "{{ playbook_dir }}/../web/"
        dest: "{{ web_root }}/"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"
      notify: restart pas-assistant

    # -------------------------------------------------------------------------
    # Application source code and configuration
    # -------------------------------------------------------------------------

    - name: Copy application source code
      copy:
        src: "{{ playbook_dir }}/../app/"
        dest: "{{ app_dir }}/app/"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"
      notify: restart pas-assistant

    - name: Copy configuration files
      copy:
        src: "{{ playbook_dir }}/../data/config/"
        dest: "{{ app_dir }}/data/config/"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"
      notify: restart pas-assistant

    - name: Copy requirements.txt
      copy:
        src: "{{ playbook_dir }}/../requirements.txt"
        dest: "{{ app_dir }}/requirements.txt"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0644"

    - name: Generate .env from vault secrets
      template:
        src: templates/.env.j2
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0600"
      notify: restart pas-assistant

    # -------------------------------------------------------------------------
    # Python virtualenv and dependencies
    # -------------------------------------------------------------------------

    - name: Create Python virtual environment
      command: python3 -m venv {{ app_dir }}/venv
      args:
        creates: "{{ app_dir }}/venv/bin/activate"

    - name: Set venv ownership
      file:
        path: "{{ app_dir }}/venv"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: true

    - name: Install Python dependencies
      pip:
        requirements: "{{ app_dir }}/requirements.txt"
        virtualenv: "{{ app_dir }}/venv"
      notify: restart pas-assistant

    # -------------------------------------------------------------------------
    # Systemd service
    # -------------------------------------------------------------------------

    - name: Deploy systemd service unit
      template:
        src: templates/pas-assistant.service.j2
        dest: /etc/systemd/system/pas-assistant.service
        mode: "0644"
      notify: restart pas-assistant

    - name: Enable and start pas-assistant service
      systemd:
        name: pas-assistant
        state: started
        enabled: true
        daemon_reload: true

    # -------------------------------------------------------------------------
    # Nginx
    # -------------------------------------------------------------------------

    - name: Remove default Nginx site
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: reload nginx

    - name: Deploy HTTP Nginx config (pre-certbot)
      template:
        src: templates/nginx-http.conf.j2
        dest: /etc/nginx/sites-available/{{ domain }}
        mode: "0644"
      notify: reload nginx

    - name: Enable Nginx site
      file:
        src: /etc/nginx/sites-available/{{ domain }}
        dest: /etc/nginx/sites-enabled/{{ domain }}
        state: link
      notify: reload nginx

    - name: Ensure Nginx is started
      service:
        name: nginx
        state: started
        enabled: true

    - name: Apply HTTP config before running certbot
      meta: flush_handlers

    - name: Obtain Let's Encrypt certificate
      command: >-
        certbot certonly --nginx
        -d {{ domain }}
        --non-interactive
        --agree-tos
        --email {{ admin_email }}
      args:
        creates: /etc/letsencrypt/live/{{ domain }}/fullchain.pem

    - name: Deploy HTTPS Nginx config (with /api/ proxy)
      template:
        src: templates/nginx-https.conf.j2
        dest: /etc/nginx/sites-available/{{ domain }}
        mode: "0644"
      notify: reload nginx

  handlers:
    - name: reload nginx
      service:
        name: nginx
        state: reloaded

    - name: restart pas-assistant
      systemd:
        name: pas-assistant
        state: restarted
        daemon_reload: true
