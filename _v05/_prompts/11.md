# Prompt 11 — Correction OOM killer (mémoire insuffisante)

## Symptôme

- Pipeline bloqué à "Anonymisation du document"
- `systemd` : `A process of this unit has been killed by the OOM killer` (43s CPU)
- Serveur 2 GB RAM / 1 CPU (DigitalOcean)

## Causes identifiées

### Cause principale : `apply_anonymization` / `apply_deanonymization` (parser_xlsx.py)
`openpyxl.load_workbook(filepath)` en mode écriture charge le workbook COMPLET en mémoire
(objet Python pour chaque cellule + styles + formules = 10-50x la taille fichier).
Sur un xlsx conséquent, cela peut consommer 300-800 MB d'un coup.

### Cause secondaire : `_read_reference_content` (reference_selector.py)
Chargement sans limite de taille des fichiers de référence xlsx du corpus.
Avec `max_files: 3`, jusqu'à 3 fichiers entiers (129 questions × toutes colonnes) sont
chargés en mémoire et envoyés dans le prompt Claude.

## Corrections

### `app/services/parser_xlsx.py`
- Import `shutil` et `zipfile` ajoutés.
- `apply_anonymization` et `apply_deanonymization` remplacées par des appels à
  `_xlsx_zip_replace(filepath, transform_fn)`.
- `_xlsx_zip_replace` : ouvre le xlsx comme ZIP, itère les entrées, applique le
  remplacement de texte uniquement sur `xl/sharedStrings.xml` et `xl/worksheets/*.xml`
  (les seuls fichiers contenant du texte utilisateur), écrit dans un `.~tmp.xlsx`,
  puis rename atomique. Pas d'openpyxl en mode écriture → ~2x la taille du fichier
  en mémoire au lieu de 10-50x.

### `app/services/reference_selector.py`
- Constante `_MAX_REF_CHARS = 30_000` (≈ 30 Ko par fichier de référence).
- `_read_reference_content` : arrêt anticipé lors de la lecture xlsx dès que le cumul
  dépasse la limite ; troncature pour docx/txt ; suffixe `[... tronqué ...]`.
  Réduit la taille totale du prompt Claude de façon prévisible.
