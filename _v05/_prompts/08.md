# Prompt 08

## Demande

L'utilisateur a constaté un blocage dans l'interface (capture d'écran). Investigation et correction des deux causes identifiées.

## Causes identifiées

### 1. Appel Claude synchrone bloquant dans l'endpoint d'upload
`POST /api/projects` appelle `claude_client.analyze_structure()` de façon synchrone dans une fonction `async` FastAPI. Cela bloque le thread de l'event loop asyncio pendant toute la durée de l'appel Claude (20-60 secondes selon la taille du fichier). Pendant ce temps, aucune autre requête ne peut être traitée.

### 2. Projets bloqués en état `generating` après un redémarrage
Si uvicorn redémarre (ex : `--reload` en dev, crash, déploiement) alors qu'une tâche de génération est en cours, le `BackgroundTask` est tué mais le `project.json` conserve `status = "generating"`. Au prochain chargement de la page, le polling retourne indéfiniment `generating` et la barre de progression ne bouge plus.

## Implémentation

### `app/api/web.py`
- Ajout de `import anyio`
- Dans `create_project()` : remplacement de `claude_client.analyze_structure(raw_content, ext)` par `await anyio.to_thread.run_sync(lambda: claude_client.analyze_structure(raw_content, ext))`. L'appel bloquant s'exécute dans un thread pool sans bloquer l'event loop.

### `app/main.py`
- Ajout de `from app.models.project import ProjectStatus`
- Nouvelle fonction `_recover_stale_generating_projects()` : au démarrage, parcourt tous les projets et remet à `error` (avec message explicite) ceux dont le statut est `generating`.
- Appel de cette fonction dans `lifespan()` après `load_config()`.
